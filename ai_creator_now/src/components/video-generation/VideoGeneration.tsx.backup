import React, { useState, useEffect } from 'react';
import {
  Video,
  Play,
  Download,
  Settings,
  ChevronDown,
  CheckCircle,
  XCircle,
  AlertCircle,
  Clock,
  Image,
  Zap,
  Eye,
  RotateCw,
  Trash2,
  Copy,
  Film,
  Key,
  AlertTriangle
} from 'lucide-react';
import {
  GeneratedVideo,
  VideoGenerationSettings,
  Scene,
  GeneratedImage,
  ImageGenerationProgress
} from '../../types';
import { useProjectStore } from '../../stores/projectStore';
import { useAPIConfigStore } from '../../stores/apiConfigStore';
import { logger } from '../../utils/logger';

interface VideoGenerationProps {
  className?: string;
}

export const VideoGeneration: React.FC<VideoGenerationProps> = ({ className = '' }) => {
  const [selectedSceneId, setSelectedSceneId] = useState<string>('');
  const [selectedImageId, setSelectedImageId] = useState<string>('');
  const [selectedConfig, setSelectedConfig] = useState<string>('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [generationHistory, setGenerationHistory] = useState<GeneratedVideo[]>([]);
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [playingVideoId, setPlayingVideoId] = useState<string | null>(null);
  const [generationSettings, setGenerationSettings] = useState<VideoGenerationSettings>({
    duration: 5,
    aspectRatio: '16:9',
    quality: 'standard',
    motionStrength: 'medium',
    style: 'realistic',
    fps: 30,
    promptEnhancement: true
  });

  const {
    currentProject,
    getSceneSelectedImages,
    isImageSelected,
    addGeneratedVideo
  } = useProjectStore();

  // Get scenes from current project
  const scenes = currentProject?.scenes || [];

  const { configurations, selectedConfigId, selectConfig, getActiveConfig } = useAPIConfigStore();

  // Filter configurations for video generation only
  const videoConfigurations = configurations.filter(config => {
    const isActive = config.isActive;
    const isVideoType = config.type === 'video' || config.type === 'both';
    const hasVideoInName = config.name.toLowerCase().includes('video') ||
                         config.name.toLowerCase().includes('视频');
    const hasVideoInEndpoint = config.endpoint.toLowerCase().includes('video') ||
                              config.endpoint.toLowerCase().includes('videos');

    // 更宽松的条件：如果名称包含视频关键词，即使是inactive或type为image也包含
    const shouldInclude = (isActive && (isVideoType || hasVideoInName || hasVideoInEndpoint)) ||
                         hasVideoInName; // 名称包含视频关键词的总是包含

    return shouldInclude;
  });

  // 记录视频配置数量用于调试
  if (videoConfigurations.length === 0) {
    logger.warn('没有找到可用的视频配置', {
      totalConfigurations: configurations.length,
      configurations: configurations.map(c => ({
        name: c.name,
        type: c.type,
        isActive: c.isActive
      }))
    });
  }

  // 如果没有视频配置，创建一个默认的Evolink视频配置
  if (videoConfigurations.length === 0) {
    logger.info('没有找到视频配置，创建默认配置');
    const defaultVideoConfig = {
      id: crypto.randomUUID(),
      name: 'Evolink 视频生成 - 默认',
      type: 'video' as const,
      endpoint: '/api/evolink/v1/videos/generations',
      method: 'POST' as const,
      headers: [
        {
          key: 'Authorization',
          value: 'Bearer your-api-key-here'
        }
      ],
      requestParams: {
        model: 'veo3.1-fast',
        aspect_ratio: '16:9'
      },
      responseParser: {
        successCode: 200,
        resultPath: '$.data[0].url',
        errorPath: '$.error'
      },
      isActive: true,
      createdAt: new Date(),
      updatedAt: new Date()
    };

    // 直接添加到videoConfigurations数组
    videoConfigurations.push(defaultVideoConfig);

    // 自动选择这个配置
    if (!selectedConfig) {
      setSelectedConfig(defaultVideoConfig.id);
    }
  }

  // Auto-select available video configurations
  useEffect(() => {
    if (videoConfigurations.length > 0 && !selectedConfig) {
      setSelectedConfig(videoConfigurations[0].id);
    }
  }, [videoConfigurations, selectedConfig]);

  useEffect(() => {
    // Auto-select available configurations
    if (selectedConfigId) {
      setSelectedConfig(selectedConfigId);
    }
  }, [selectedConfigId]);

  // Load video generation history
  useEffect(() => {
    loadVideoHistory();
  }, [currentProject, scenes]);

  const loadVideoHistory = () => {
    if (!currentProject || !scenes) return;

    // Get all videos from scenes
    const allVideos: GeneratedVideo[] = [];
    scenes.forEach(scene => {
      if (scene.generatedVideo) {
        allVideos.push(scene.generatedVideo);
      }
    });

    // Sort by creation date (newest first)
    allVideos.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
    setGenerationHistory(allVideos);
  };

  const handleImageSelect = (sceneId: string, imageId: string) => {
    setSelectedSceneId(sceneId);
    setSelectedImageId(imageId);
  };

  const handleGenerateVideo = async () => {
    if (!selectedImageId || !selectedSceneId) {
      alert('请先选择要生成视频的图片');
      return;
    }

    if (!selectedConfig) {
      alert('请先选择API配置');
      return;
    }

    // Get the selected configuration (must be video-capable)
    const videoConfig = videoConfigurations.find(c => c.id === selectedConfig);
    if (!videoConfig) {
      alert('没有找到支持视频生成的API配置，请确保API配置的类型设置为"视频"或"两者"');
      return;
    }

    setIsGenerating(true);

    try {
      logger.info('开始视频生成', {
        sceneId: selectedSceneId,
        imageId: selectedImageId,
        settings: generationSettings
      });

      // Get the selected scene and image
      const scene = scenes.find(s => s.id === selectedSceneId);
      if (!scene) {
        throw new Error('未找到选中图片的场景');
      }

      const selectedImage = scene.images.find(img => img.id === selectedImageId);
      if (!selectedImage) {
        throw new Error('未找到选中的图片');
      }

      // Create video generation request
      const videoRequest = {
        imageUrl: selectedImage.url,
        prompt: scene.videoPrompt || scene.imagePrompt,
        settings: generationSettings,
        provider: videoConfig.name
      };

      logger.info('视频生成请求', videoRequest);

      // Call the video generation API
      const apiResponse = await callVideoGenerationAPI(videoRequest);

      // Create video from API response
      const generatedVideo: GeneratedVideo = {
        id: apiResponse.id || `video_${Date.now()}`,
        url: apiResponse.url || apiResponse.videoUrl,
        thumbnailUrl: apiResponse.thumbnailUrl || selectedImage.url,
        provider: videoConfig.name,
        sourceImageId: selectedImageId,
        prompt: scene.videoPrompt || scene.imagePrompt,
        settings: generationSettings,
        metadata: {
          duration: apiResponse.duration || generationSettings.duration,
          aspectRatio: apiResponse.aspectRatio || generationSettings.aspectRatio,
          resolution: apiResponse.resolution || '1280x720',
          format: apiResponse.format || 'mp4',
          fileSize: apiResponse.fileSize || 5242880,
          frameRate: apiResponse.frameRate || generationSettings.fps,
          model: apiResponse.model || videoConfig.name
        },
        createdAt: new Date()
      };

      // Add video to scene and store
      addGeneratedVideo(selectedSceneId, generatedVideo);

      // Refresh history
      loadVideoHistory();

      logger.info('视频生成完成', { videoId: generatedVideo.id, url: generatedVideo.url });

      alert('视频生成完成！');

    } catch (error) {
      logger.error('视频生成失败', error);

      let errorMessage = `视频生成失败: ${error instanceof Error ? error.message : '未知错误'}`;

      // Special handling for model access issues
      if (error instanceof Error && error.message.includes('无可用渠道')) {
        errorMessage = `视频生成模型权限不足\n\n您的API密钥无法访问视频生成模型(veo3.1)。\n\n解决方案：\n1. 联系Evolink客服申请veo3.1模型权限\n2. 或升级到支持视频生成的API套餐\n\n当前系统将尝试使用其他模型，但可能只生成图片而非视频。`;
      }

      alert(errorMessage);
    } finally {
      setIsGenerating(false);
    }
  };

  const callVideoGenerationAPI = async (request: any) => {
    try {
      logger.info('开始调用视频生成API', { provider: request.provider });

      // Get the selected configuration (must be video-capable)
      const config = videoConfigurations.find(c => c.id === selectedConfig);
      if (!config) {
        throw new Error('未找到支持视频生成的API配置');
      }

      // Evolink uses the same endpoint for both images and videos
      // The API determines the output type based on the request parameters

      // Prepare API request for Evolink video generation using correct video API
      const apiRequest = {
        prompt: request.prompt,
        image_urls: [request.imageUrl], // Use array format for image-to-video
        aspect_ratio: request.settings.aspectRatio, // Video API uses aspect_ratio
        model: config.requestParams?.model || 'veo3.1-fast' // Use correct video model
      };

      // Detect Evolink by checking if the endpoint path or name contains 'evolink'
      const isEvolink = config.endpoint.includes('evolink.ai') ||
                       config.endpoint.includes('/api/evolink/v1/images/generations') ||
                       config.endpoint.includes('/api/evolink/v1/videos/generations') ||
                       config.name.toLowerCase().includes('evolink');

      // Use the user's selected endpoint
      let apiEndpoint = config.endpoint;

      // For Evolink configurations, ensure using the correct video endpoint
      if (isEvolink) {
        // If user configured image endpoint but is doing video generation, redirect to video endpoint
        if (apiEndpoint.includes('/images/generations')) {
          apiEndpoint = apiEndpoint.replace('/images/generations', '/videos/generations');
        }
      }

      const response = await fetch(apiEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': config.headers.find(h => h.key === 'Authorization')?.value || ''
        },
        body: JSON.stringify(apiRequest)
      });

      let data;
      let responseText = '';
      try {
        responseText = await response.text();

        if (responseText.length === 0) {
          throw new Error('API返回空响应');
        }

        data = JSON.parse(responseText);
      } catch (parseError) {
        logger.error('JSON解析失败', {
          parseError: parseError.message,
          responseStatus: response.status
        });
        throw new Error(`JSON解析失败: ${parseError.message}`);
      }

      if (!response.ok) {
        // Provide more specific error messages
        if (response.status === 401) {
          throw new Error('API密钥无效或已过期。请检查API配置。');
        } else {
          // Try to extract meaningful error message
          let errorMessage = '未知错误';
          if (typeof data === 'string') {
            errorMessage = data;
          } else if (data && typeof data === 'object') {
            errorMessage = data.error || data.message || data.detail || JSON.stringify(data);
          }

          throw new Error(`API调用失败 (${response.status}): ${errorMessage}`);
        }
      }

      return data;
    } catch (error) {
      logger.error('视频生成API调用失败', error);
      throw error;
    }
  };

  const handleDownloadVideo = (video: GeneratedVideo) => {
    // Create download link
    const link = document.createElement('a');
    link.href = video.url;
    link.download = `video_${video.id}.mp4`;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    logger.info('视频下载', { videoId: video.id });
  };

  const handleDeleteVideo = (videoId: string) => {
    if (confirm('确定要删除这个视频吗？此操作无法撤销。')) {
      // In a real implementation, this would delete from the database
      logger.info('视频删除', { videoId });
      loadVideoHistory();
    }
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text).then(() => {
      alert('已复制到剪贴板');
    }).catch(() => {
      alert('复制失败');
    });
  };

  const handlePlayVideo = (videoId: string) => {
    setPlayingVideoId(playingVideoId === videoId ? null : videoId);
  };

  const selectedConfigInfo = configurations.find(c => c.id === selectedConfig);

  const formatDuration = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  // Group images by scene for selection
  const imagesByScene = (scenes || []).map(scene => {
    // Images are stored directly in the scene
    let sceneImages = scene.images || [];

    // Ensure all images have proper metadata with sceneId
    sceneImages = sceneImages.map(img => ({
      ...img,
      metadata: {
        ...img.metadata,
        sceneId: img.metadata?.sceneId || scene.id // Ensure sceneId is set
      }
    }));

    return {
      scene,
      images: sceneImages
    };
  }).filter(item => item.images.length > 0);

  // Debug logging
  console.log('Video Generation Debug:', {
    currentProject: currentProject?.name,
    scenesCount: scenes?.length,
    imagesBySceneCount: imagesByScene.length,
    totalImages: imagesByScene.reduce((sum, item) => sum + item.images.length, 0),
    imagesByScene: imagesByScene.map(item => ({
      sceneId: item.scene.id,
      sceneNumber: item.scene.sceneNumber,
      imagesCount: item.images.length,
      hasImages: item.images.length > 0
    }))
  });

  // API密钥检查和修复功能
  const checkAndUpdateAPIKey = () => {
    const selectedConfig = configurations.find(c => c.id === selectedConfig);
    if (!selectedConfig) return null;

    const authHeader = selectedConfig.headers?.find(h => h.key === 'Authorization')?.value || '';
    const hasPlaceholderKey = authHeader.includes('your-api-key-here') ||
                             authHeader.includes('YOUR_API_KEY') ||
                             authHeader === '';

    if (hasPlaceholderKey) {
      return {
        needsUpdate: true,
        configName: selectedConfig.name,
        currentKey: authHeader.substring(0, 20) + '...'
      };
    }

    return { needsUpdate: false };
  };

  const apiKeyStatus = checkAndUpdateAPIKey();

  const updateAPIKey = (newKey: string) => {
    const selectedConfig = configurations.find(c => c.id === selectedConfig);
    if (!selectedConfig) return;

    const updatedConfig = {
      ...selectedConfig,
      headers: selectedConfig.headers.map(header =>
        header.key === 'Authorization'
          ? { ...header, value: `Bearer ${newKey.replace(/^Bearer\s+/, '')}` }
          : header
      ),
      isActive: true,
      updatedAt: new Date()
    };

    const { updateConfiguration } = useAPIConfigStore.getState();
    updateConfiguration(selectedConfig.id, updatedConfig);

    // 重新加载页面以更新配置
    window.location.reload();
  };

  return (
    <div className={`space-y-apple-lg ${className}`}>
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-sf-pro-display font-semibold text-gray-900 flex items-center space-x-2">
            <Film className="w-6 h-6 text-blue-600" />
            <span>视频生成</span>
          </h2>
          <p className="text-sm font-sf-pro-text text-gray-600 mt-apple-xs">
            选择图片生成动态视频内容
          </p>
        </div>
      </div>

      {/* API密钥警告 */}
      {apiKeyStatus?.needsUpdate && (
        <div className="bg-amber-50 border border-amber-200 rounded-lg p-apple-md">
          <div className="flex items-start space-x-apple-sm">
            <AlertTriangle className="w-5 h-5 text-amber-600 mt-apple-xs flex-shrink-0" />
            <div className="flex-1">
              <h3 className="text-sm font-sf-pro-text font-medium text-amber-800">
                API密钥需要更新
              </h3>
              <p className="text-xs font-sf-pro-text text-amber-700 mt-apple-xs">
                配置 "{apiKeyStatus.configName}" 使用的是占位符API密钥，无法正常生成视频。
              </p>
              <div className="mt-apple-sm">
                <input
                  type="password"
                  id="apiKeyInput"
                  placeholder="请输入您的Evollink API密钥"
                  className="w-full px-apple-sm py-apple-xs border border-amber-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                />
                <button
                  onClick={() => {
                    const input = document.getElementById('apiKeyInput') as HTMLInputElement;
                    if (input.value.trim()) {
                      updateAPIKey(input.value.trim());
                    }
                  }}
                  className="mt-apple-xs px-apple-sm py-apple-xs bg-amber-600 text-white text-xs rounded hover:bg-amber-700 transition-colors duration-200 flex items-center space-x-1"
                >
                  <Key className="w-3 h-3" />
                  <span>更新API密钥</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Header Actions */}
      <div className="flex justify-end">
        <button
          onClick={() => setShowAdvanced(!showAdvanced)}
          className="glass-card px-apple-md py-apple-sm flex items-center space-x-2 hover:bg-gray-50/50 transition-colors duration-200"
        >
          <Settings className="w-4 h-4 text-gray-600" />
          <span className="text-sm font-sf-pro-text text-gray-700">
            {showAdvanced ? '隐藏设置' : '高级设置'}
          </span>
          <ChevronDown className={`w-4 h-4 text-gray-500 transition-transform duration-200 ${
            showAdvanced ? 'rotate-180' : ''
          }`} />
        </button>
      </div>

      {/* API Configuration */}
      <div className="glass-card border border-gray-200/50 p-apple-lg">
        <h3 className="text-lg font-sf-pro-display font-medium text-gray-900 mb-apple-md">API配置</h3>

        <div className="space-y-apple-md">
          <div>
            <label className="block text-sm font-sf-pro-text font-medium text-gray-700 mb-apple-xs">
              选择AI服务
            </label>
            <select
              value={selectedConfig}
              onChange={(e) => {
                setSelectedConfig(e.target.value);
                selectConfig(e.target.value);
              }}
              className="w-full px-apple-sm py-apple-xs border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">请选择API配置...</option>
              {configurations.map(config => (
                <option key={config.id} value={config.id}>
                  {config.name}
                </option>
              ))}
            </select>
          </div>

          {showAdvanced && selectedConfigInfo && (
            <div className="space-y-apple-sm">
              <div className="text-sm font-sf-pro-text text-gray-600">
                <span className="font-medium">端点:</span>
                <code className="ml-2 text-xs bg-gray-100 px-apple-sm py-1 rounded">
                  {selectedConfigInfo.endpoint}
                </code>
              </div>
              <div className="text-sm font-sf-pro-text text-gray-600">
                <span className="font-medium">类型:</span>
                <span className="ml-2">{selectedConfigInfo.type}</span>
              </div>
              <div className="text-sm font-sf-pro-text text-gray-600">
                <span className="font-medium">状态:</span>
                <span className={`ml-2 ${selectedConfigInfo.isActive ? 'text-green-600' : 'text-gray-500'}`}>
                  {selectedConfigInfo.isActive ? '已启用' : '未启用'}
                </span>
              </div>
            </div>
          )}
        </div>

        {!selectedConfig && (
          <div className="mt-apple-md p-apple-sm bg-yellow-50/50 border border-yellow-200/50 rounded-lg">
            <div className="flex items-start space-x-2">
              <AlertCircle className="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0" />
              <div>
                <p className="text-sm font-sf-pro-text text-yellow-800">
                  请先选择API配置
                </p>
                <p className="text-xs font-sf-pro-text text-yellow-700 mt-1">
                  前往"API配置"页面创建和配置AI服务
                </p>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Advanced Settings */}
      {showAdvanced && (
        <div className="glass-card border border-gray-200/50 p-apple-lg space-y-apple-md">
          <h3 className="text-lg font-sf-pro-display font-medium text-gray-900 mb-apple-md">视频生成设置</h3>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-apple-md">
            {/* Duration */}
            <div>
              <label className="block text-sm font-sf-pro-text font-medium text-gray-700 mb-apple-xs">
                视频时长 (秒)
              </label>
              <input
                type="number"
                min="1"
                max="30"
                value={generationSettings.duration}
                onChange={(e) => setGenerationSettings(prev => ({
                  ...prev,
                  duration: parseInt(e.target.value) || 5
                }))}
                className="w-full px-apple-sm py-apple-xs border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>

            {/* Aspect Ratio */}
            <div>
              <label className="block text-sm font-sf-pro-text font-medium text-gray-700 mb-apple-xs">
                视频比例
              </label>
              <select
                value={generationSettings.aspectRatio}
                onChange={(e) => setGenerationSettings(prev => ({
                  ...prev,
                  aspectRatio: e.target.value as any
                }))}
                className="w-full px-apple-sm py-apple-xs border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="16:9">16:9 (横屏)</option>
                <option value="9:16">9:16 (竖屏)</option>
                <option value="1:1">1:1 (正方形)</option>
                <option value="4:3">4:3 (经典)</option>
              </select>
            </div>

            {/* Quality */}
            <div>
              <label className="block text-sm font-sf-pro-text font-medium text-gray-700 mb-apple-xs">
                视频质量
              </label>
              <select
                value={generationSettings.quality}
                onChange={(e) => setGenerationSettings(prev => ({
                  ...prev,
                  quality: e.target.value as any
                }))}
                className="w-full px-apple-sm py-apple-xs border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="standard">标准</option>
                <option value="high">高清</option>
                <option value="ultra">超高清</option>
              </select>
            </div>

            {/* Motion Strength */}
            <div>
              <label className="block text-sm font-sf-pro-text font-medium text-gray-700 mb-apple-xs">
                运动强度
              </label>
              <select
                value={generationSettings.motionStrength}
                onChange={(e) => setGenerationSettings(prev => ({
                  ...prev,
                  motionStrength: e.target.value as any
                }))}
                className="w-full px-apple-sm py-apple-xs border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="subtle">轻微</option>
                <option value="medium">中等</option>
                <option value="strong">强烈</option>
              </select>
            </div>

            {/* Style */}
            <div>
              <label className="block text-sm font-sf-pro-text font-medium text-gray-700 mb-apple-xs">
                视频风格
              </label>
              <select
                value={generationSettings.style}
                onChange={(e) => setGenerationSettings(prev => ({
                  ...prev,
                  style: e.target.value as any
                }))}
                className="w-full px-apple-sm py-apple-xs border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="realistic">写实</option>
                <option value="cinematic">电影</option>
                <option value="artistic">艺术</option>
                <option value="animated">动画</option>
              </select>
            </div>

            {/* FPS */}
            <div>
              <label className="block text-sm font-sf-pro-text font-medium text-gray-700 mb-apple-xs">
                帧率 (FPS)
              </label>
              <select
                value={generationSettings.fps}
                onChange={(e) => setGenerationSettings(prev => ({
                  ...prev,
                  fps: parseInt(e.target.value)
                }))}
                className="w-full px-apple-sm py-apple-xs border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="24">24 FPS</option>
                <option value="30">30 FPS</option>
                <option value="60">60 FPS</option>
              </select>
            </div>
          </div>

          {/* Prompt Enhancement */}
          <div className="flex items-center space-x-2">
            <input
              type="checkbox"
              id="promptEnhancement"
              checked={generationSettings.promptEnhancement}
              onChange={(e) => setGenerationSettings(prev => ({
                ...prev,
                promptEnhancement: e.target.checked
              }))}
              className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <label htmlFor="promptEnhancement" className="text-sm font-sf-pro-text text-gray-700">
              启用提示词增强 (自动优化视频生成效果)
            </label>
          </div>
        </div>
      )}

      {/* Image Selection */}
      <div className="glass-card border border-gray-200/50 p-apple-lg">
        <h3 className="text-lg font-sf-pro-display font-medium text-gray-900 mb-apple-md">
          选择图片生成视频
        </h3>

        {imagesByScene.length === 0 ? (
          <div className="text-center py-apple-xl">
            <Image className="w-12 h-12 text-gray-300 mx-auto mb-apple-sm" />
            <p className="text-sm font-sf-pro-text text-gray-500 mb-apple-xs">
              还没有生成的图片
            </p>
            <p className="text-xs font-sf-pro-text text-gray-400">
              请先在"图像生成"页面生成图片
            </p>
          </div>
        ) : (
          <div className="space-y-apple-lg">
            {imagesByScene.map(({ scene, images }) => (
              <div key={scene.id} className="border border-gray-200/50 rounded-lg p-apple-md">
                <div className="flex items-center space-x-2 mb-apple-sm">
                  <Film className="w-4 h-4 text-blue-600" />
                  <h4 className="font-sf-pro-display font-medium text-gray-900">
                    场景 {scene.sceneNumber}: {scene.title}
                  </h4>
                  <span className="text-xs font-sf-pro-text text-gray-500">
                    ({images.length} 张图片)
                  </span>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-apple-sm">
                  {images.map((image) => (
                    <div
                      key={image.id}
                      className={`relative group cursor-pointer border-2 rounded-lg overflow-hidden transition-all duration-200 ${
                        selectedImageId === image.id
                          ? 'border-blue-500 ring-2 ring-blue-200'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                      onClick={() => handleImageSelect(scene.id, image.id)}
                    >
                      <img
                        src={image.url}
                        alt={image.prompt}
                        className="w-full h-24 object-cover"
                      />

                      {/* Selection Indicator */}
                      {selectedImageId === image.id && (
                        <div className="absolute top-1 right-1 bg-blue-600 text-white rounded-full p-1">
                          <CheckCircle className="w-3 h-3" />
                        </div>
                      )}

                      {/* Hover Overlay */}
                      <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                        <Eye className="w-4 h-4 text-white" />
                      </div>

                      {/* Image Info */}
                      <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2">
                        <p className="text-xs font-sf-pro-text text-white truncate">
                          {image.prompt}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Generate Button */}
        <div className="mt-apple-lg flex justify-center">
          <button
            onClick={handleGenerateVideo}
            disabled={!selectedImageId || !selectedConfig || isGenerating}
            className={`px-apple-xl py-apple-md rounded-lg font-sf-pro-text font-medium flex items-center space-x-2 transition-all duration-200 ${
              selectedImageId && selectedConfig && !isGenerating
                ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-md hover:shadow-lg'
                : 'bg-gray-200 text-gray-400 cursor-not-allowed'
            }`}
          >
            {isGenerating ? (
              <>
                <RotateCw className="w-4 h-4 animate-spin" />
                <span>正在生成视频...</span>
              </>
            ) : (
              <>
                <Video className="w-4 h-4" />
                <span>生成视频</span>
              </>
            )}
          </button>
        </div>
      </div>

      {/* Video History */}
      <div className="glass-card border border-gray-200/50 p-apple-lg">
        <h3 className="text-lg font-sf-pro-display font-medium text-gray-900 mb-apple-md">
          视频生成历史
        </h3>

        {generationHistory.length === 0 ? (
          <div className="text-center py-apple-xl">
            <Video className="w-12 h-12 text-gray-300 mx-auto mb-apple-sm" />
            <p className="text-sm font-sf-pro-text text-gray-500">
              还没有生成的视频
            </p>
            <p className="text-xs font-sf-pro-text text-gray-400">
              选择图片并点击"生成视频"开始创建
            </p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-apple-md">
            {generationHistory.map((video) => (
              <div
                key={video.id}
                className="border border-gray-200/50 rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-200"
              >
                {/* Video Player */}
                <div className="relative aspect-video bg-gray-100">
                  {playingVideoId === video.id ? (
                    <video
                      src={video.url}
                      controls
                      autoPlay
                      className="w-full h-full object-cover"
                      onEnded={() => setPlayingVideoId(null)}
                    />
                  ) : (
                    <>
                      <img
                        src={video.thumbnailUrl}
                        alt={video.prompt}
                        className="w-full h-full object-cover"
                      />

                      {/* Play Button Overlay */}
                      <button
                        onClick={() => handlePlayVideo(video.id)}
                        className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity duration-200"
                      >
                        <Play className="w-8 h-8 text-white" />
                      </button>

                      {/* Video Badge */}
                      <div className="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded-full flex items-center space-x-1">
                        <Video className="w-3 h-3" />
                        <span>视频</span>
                      </div>
                    </>
                  )}
                </div>

                {/* Video Info */}
                <div className="p-apple-sm">
                  <h4 className="font-sf-pro-display font-medium text-gray-900 text-sm truncate mb-apple-xs">
                    {video.prompt}
                  </h4>

                  <div className="flex items-center justify-between text-xs font-sf-pro-text text-gray-500 mb-apple-xs">
                    <span>{video.provider}</span>
                    <span>{formatDuration(video.metadata.duration)}</span>
                  </div>

                  <div className="flex items-center justify-between text-xs font-sf-pro-text text-gray-500 mb-apple-sm">
                    <span>{video.metadata.aspectRatio}</span>
                    <span>{formatFileSize(video.metadata.fileSize)}</span>
                  </div>

                  {/* Actions */}
                  <div className="flex items-center space-x-1">
                    <button
                      onClick={() => handleDownloadVideo(video)}
                      className="flex-1 px-apple-sm py-apple-xs bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center space-x-1"
                    >
                      <Download className="w-3 h-3" />
                      <span>下载</span>
                    </button>

                    <button
                      onClick={() => copyToClipboard(video.url)}
                      className="p-apple-xs text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors duration-200"
                      title="复制链接"
                    >
                      <Copy className="w-3 h-3" />
                    </button>

                    <button
                      onClick={() => handleDeleteVideo(video.id)}
                      className="p-apple-xs text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-colors duration-200"
                      title="删除视频"
                    >
                      <Trash2 className="w-3 h-3" />
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

export default VideoGeneration;