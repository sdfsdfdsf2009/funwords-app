import React, { useState, useEffect } from 'react';
import { Play, Pause, RotateCw, AlertTriangle, CheckCircle, Clock, MouseClick, Navigation, Zap, Bug, Eye } from 'lucide-react';
import { errorMonitor } from '../../utils/errorMonitor';
import { useProjectStore } from '../../stores/projectStore';
import { useAPIConfigStore } from '../../stores/apiConfigStore';
import { useRouter } from 'next/router';

interface TestResult {
  testId: string;
  testName: string;
  status: 'pending' | 'running' | 'passed' | 'failed' | 'error';
  startTime: Date | null;
  endTime: Date | null;
  duration: number | null;
  error: string | null;
  details: any;
}

interface UserAction {
  id: string;
  action: string;
  target: string;
  timestamp: Date;
  success: boolean;
  error?: string;
  responseTime?: number;
}

interface TestScenario {
  id: string;
  name: string;
  description: string;
  priority: 'high' | 'medium' | 'low';
  category: 'project' | 'scene' | 'api' | 'generation' | 'navigation';
  steps: TestStep[];
}

interface TestStep {
  id: string;
  name: string;
  action: string;
  target: string;
  expected: string;
  timeout: number;
}

export const UserInteractionTester: React.FC = () => {
  const [testResults, setTestResults] = useState<TestResult[]>([]);
  const [currentTest, setCurrentTest] = useState<string | null>(null);
  const [isTestRunning, setIsTestRunning] = useState(false);
  const [userActions, setUserActions] = useState<UserAction[]>([]);
  const [testHistory, setTestHistory] = useState<TestResult[]>([]);
  const [expandedScenarios, setExpandedScenarios] = useState<Set<string>>(new Set());
  const [autoMode, setAutoMode] = useState(false);
  const [testSpeed, setTestSpeed] = useState<'slow' | 'normal' | 'fast'>('normal');

  const { createProject, deleteProject, projects, currentProject } = useProjectStore();
  const { configurations } = useAPIConfigStore();
  const router = useRouter();

  // é¢„å®šä¹‰çš„æµ‹è¯•åœºæ™¯
  const testScenarios: TestScenario[] = [
    {
      id: 'project-creation',
      name: 'é¡¹ç›®åˆ›å»ºæµç¨‹',
      description: 'æµ‹è¯•åˆ›å»ºæ–°é¡¹ç›®çš„å®Œæ•´æµç¨‹',
      priority: 'high',
      category: 'project',
      steps: [
        {
          id: 'create-project-with-name',
          name: 'åˆ›å»ºå¸¦åç§°çš„é¡¹ç›®',
          action: 'åˆ›å»ºé¡¹ç›® "æµ‹è¯•é¡¹ç›®äº¤äº’"',
          target: 'ProjectSelector.createProject',
          expected: 'é¡¹ç›®åˆ›å»ºæˆåŠŸï¼Œå‡ºç°åœ¨é¡¹ç›®åˆ—è¡¨ä¸­',
          timeout: 5000
        },
        {
          id: 'verify-project-in-list',
          name: 'éªŒè¯é¡¹ç›®åœ¨åˆ—è¡¨ä¸­',
          action: 'æ£€æŸ¥é¡¹ç›®åˆ—è¡¨',
          target: 'ProjectSelector.projects',
          expected: 'æ–°åˆ›å»ºçš„é¡¹ç›®å‡ºç°åœ¨é¡¹ç›®åˆ—è¡¨é¡¶éƒ¨',
          timeout: 3000
        }
      ]
    },
    {
      id: 'project-switching',
      name: 'é¡¹ç›®åˆ‡æ¢æµç¨‹',
      description: 'æµ‹è¯•åœ¨ä¸åŒé¡¹ç›®é—´åˆ‡æ¢çš„æµç¨‹',
      priority: 'high',
      category: 'project',
      steps: [
        {
          id: 'switch-between-projects',
          name: 'åˆ‡æ¢é¡¹ç›®',
          action: 'é€‰æ‹©å¹¶åˆ‡æ¢åˆ°é¡¹ç›®',
          target: 'ProjectSelector.setCurrentProject',
          expected: 'å½“å‰é¡¹ç›®æ›´æ–°ï¼Œç•Œé¢çŠ¶æ€åŒæ­¥',
          timeout: 3000
        },
        {
          id: 'verify-current-project-display',
          name: 'éªŒè¯å½“å‰é¡¹ç›®æ˜¾ç¤º',
          action: 'æ£€æŸ¥å½“å‰é¡¹ç›®æ˜¾ç¤º',
          target: 'ProjectSelector.currentProject',
          expected: 'é¡¹ç›®é€‰æ‹©å™¨æ˜¾ç¤ºæ­£ç¡®çš„å½“å‰é¡¹ç›®',
          timeout: 2000
        }
      ]
    },
    {
      id: 'project-deletion',
      name: 'é¡¹ç›®åˆ é™¤æµç¨‹',
      description: 'æµ‹è¯•å®‰å…¨åˆ é™¤é¡¹ç›®çš„æµç¨‹',
      priority: 'medium',
      category: 'project',
      steps: [
        {
          id: 'delete-project-safely',
          name: 'å®‰å…¨åˆ é™¤é¡¹ç›®',
          action: 'åˆ é™¤éå½“å‰é¡¹ç›®',
          target: 'ProjectSelector.deleteProject',
          expected: 'é¡¹ç›®è¢«å®‰å…¨åˆ é™¤ï¼Œä¸å†å‡ºç°åœ¨åˆ—è¡¨ä¸­',
          timeout: 5000
        },
        {
          id: 'verify-deletion-warning',
          name: 'éªŒè¯åˆ é™¤è­¦å‘Š',
          action: 'å°è¯•åˆ é™¤æœ€åä¸€ä¸ªé¡¹ç›®',
          target: 'ProjectSelector.deleteProject',
          expected: 'æ˜¾ç¤ºé€‚å½“çš„è­¦å‘Šä¿¡æ¯ï¼Œé˜»æ­¢åˆ é™¤',
          timeout: 3000
        }
      ]
    },
    {
      id: 'navigation-flow',
      name: 'é¡µé¢å¯¼èˆªæµç¨‹',
      description: 'æµ‹è¯•åœ¨ä¸åŒé¡µé¢é—´å¯¼èˆªçš„æµç¨‹',
      priority: 'high',
      category: 'navigation',
      steps: [
        {
          id: 'navigate-to-scenes',
          name: 'å¯¼èˆªåˆ°åœºæ™¯é¡µé¢',
          action: 'ç‚¹å‡»åœºæ™¯ç®¡ç†å¯¼èˆª',
          target: 'Navigation.scenes',
          expected: 'æˆåŠŸå¯¼èˆªåˆ°åœºæ™¯ç®¡ç†é¡µé¢',
          timeout: 3000
        },
        {
          id: 'navigate-to-generation',
          name: 'å¯¼èˆªåˆ°ç”Ÿæˆé¡µé¢',
          action: 'ç‚¹å‡»è§†é¢‘ç”Ÿæˆå¯¼èˆª',
          target: 'Navigation.generation',
          expected: 'æˆåŠŸå¯¼èˆªåˆ°è§†é¢‘ç”Ÿæˆé¡µé¢',
          timeout: 3000
        },
        {
          id: 'navigate-to-debug',
          name: 'å¯¼èˆªåˆ°è°ƒè¯•é¡µé¢',
          action: 'ç‚¹å‡»è°ƒè¯•å·¥å…·å¯¼èˆª',
          target: 'Navigation.debug',
          expected: 'æˆåŠŸå¯¼èˆªåˆ°è°ƒè¯•å·¥å…·é¡µé¢',
          timeout: 3000
        },
        {
          id: 'verify-navigation-consistency',
          name: 'éªŒè¯å¯¼èˆªä¸€è‡´æ€§',
          action: 'å¤šæ¬¡å¯¼èˆªåæ£€æŸ¥',
          target: 'Navigation',
          expected: 'å¯¼èˆªçŠ¶æ€ä¿æŒä¸€è‡´ï¼ŒURLæ­£ç¡®æ›´æ–°',
          timeout: 2000
        }
      ]
    },
    {
      id: 'form-interaction',
      name: 'è¡¨å•äº¤äº’æµç¨‹',
      description: 'æµ‹è¯•å„ç§è¡¨å•çš„ç”¨æˆ·äº¤äº’',
      priority: 'medium',
      category: 'api',
      steps: [
        {
          id: 'fill-project-form',
          name: 'å¡«å†™é¡¹ç›®è¡¨å•',
          action: 'è¾“å…¥é¡¹ç›®åç§°',
          target: 'ProjectForm.nameInput',
          expected: 'è¾“å…¥è¢«æ­£ç¡®æ¥å—ï¼Œè¡¨å•çŠ¶æ€æ›´æ–°',
          timeout: 3000
        },
        {
          id: 'form-validation',
          name: 'è¡¨å•éªŒè¯æµ‹è¯•',
          action: 'å°è¯•æäº¤ç©ºè¡¨å•',
          target: 'ProjectForm.submit',
          expected: 'æ˜¾ç¤ºéªŒè¯é”™è¯¯ï¼Œé˜»æ­¢æäº¤',
          timeout: 3000
        }
      ]
    },
    {
      id: 'error-recovery',
      name: 'é”™è¯¯æ¢å¤æµç¨‹',
      description: 'æµ‹è¯•ä»é”™è¯¯çŠ¶æ€æ¢å¤çš„æµç¨‹',
      priority: 'high',
      category: 'generation',
      steps: [
        {
          id: 'trigger-recoverable-error',
          name: 'è§¦å‘å¯æ¢å¤é”™è¯¯',
          action: 'æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯æˆ–APIé”™è¯¯',
          target: 'ErrorBoundary.testError',
          expected: 'é”™è¯¯è¢«æ­£ç¡®æ•è·ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º',
          timeout: 3000
        },
        {
          id: 'error-recovery-action',
          name: 'æ‰§è¡Œæ¢å¤æ“ä½œ',
          action: 'ç‚¹å‡»é‡è¯•æˆ–æ¢å¤æŒ‰é’®',
          target: 'ErrorBoundary.retry',
          expected: 'æˆåŠŸä»é”™è¯¯çŠ¶æ€æ¢å¤ï¼Œåº”ç”¨ç»§ç»­æ­£å¸¸å·¥ä½œ',
          timeout: 5000
        }
      ]
    }
  ];

  const getTimeoutDelay = () => {
    switch (testSpeed) {
      case 'slow': return 2;
      case 'fast': return 0.5;
      default: return 1;
    }
  };

  const executeTest = async (scenario: TestScenario) => {
    const testId = scenario.id;
    const startTime = new Date();

    const testResult: TestResult = {
      testId,
      testName: scenario.name,
      status: 'running',
      startTime,
      endTime: null,
      duration: null,
      error: null,
      details: {
        scenario: scenario,
        steps: [],
        totalSteps: scenario.steps.length,
        completedSteps: 0
      }
    };

    setCurrentTest(testId);
    setTestResults(prev => [...prev.filter(r => r.testId !== testId), testResult]);

    try {
      for (let i = 0; i < scenario.steps.length; i++) {
        const step = scenario.steps[i];
        const stepStartTime = Date.now();

        // æ‰§è¡Œæµ‹è¯•æ­¥éª¤
        await executeStep(step, i + 1, scenario.steps.length);

        const stepEndTime = Date.now();
        const stepDuration = stepEndTime - stepStartTime;

        testResult.details.steps.push({
          ...step,
          duration: stepDuration,
          status: 'completed'
        });
        testResult.details.completedSteps = i + 1;

        // æ›´æ–°æµ‹è¯•ç»“æœ
        setTestResults(prev =>
          prev.map(r =>
            r.testId === testId
              ? { ...r, details: testResult.details }
              : r
          )
        );

        // æ­¥éª¤é—´éš”
        if (i < scenario.steps.length - 1) {
          await sleep(1000 * getTimeoutDelay());
        }
      }

      const endTime = new Date();
      testResult.status = 'passed';
      testResult.endTime = endTime;
      testResult.duration = endTime.getTime() - startTime.getTime();

      setUserActions(prev => [...prev, {
        id: `test-${testId}-complete`,
        action: scenario.name,
        target: 'TestSuite',
        timestamp: new Date(),
        success: true,
        responseTime: testResult.duration
      }]);

    } catch (error) {
      const endTime = new Date();
      testResult.status = 'failed';
      testResult.endTime = endTime;
      testResult.duration = endTime.getTime() - startTime.getTime();
      testResult.error = error instanceof Error ? error.message : String(error);

      setUserActions(prev => [...prev, {
        id: `test-${testId}-failed`,
        action: scenario.name,
        target: 'TestSuite',
        timestamp: new Date(),
        success: false,
        error: testResult.error
      }]);

      // è®°å½•é”™è¯¯åˆ°ç›‘æ§ç³»ç»Ÿ
      errorMonitor.logError({
        type: 'javascript',
        message: `æµ‹è¯•å¤±è´¥: ${scenario.name} - ${testResult.error}`,
        source: 'UserInteractionTester',
        context: {
          testId,
          scenario,
          error
        }
      });
    }

    setCurrentTest(null);
    setTestResults(prev =>
      prev.map(r =>
        r.testId === testId
          ? testResult
          : r
      )
    );

    setTestHistory(prev => [testResult, ...prev.slice(0, 49)]); // ä¿ç•™æœ€è¿‘50ä¸ªæµ‹è¯•ç»“æœ
  };

  const executeStep = async (step: TestStep, stepNumber: number, totalSteps: number) => {
    console.log(`ğŸ§ª æ‰§è¡Œæ­¥éª¤ ${stepNumber}/${totalSteps}: ${step.name}`);

    // æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œå»¶è¿Ÿ
    await sleep(500 * getTimeoutDelay());

    // æ ¹æ®æ­¥éª¤ç±»å‹æ‰§è¡Œä¸åŒçš„æµ‹è¯•é€»è¾‘
    switch (step.target) {
      case 'ProjectSelector.createProject':
        await testProjectCreation(step);
        break;
      case 'ProjectSelector.setCurrentProject':
        await testProjectSwitching(step);
        break;
      case 'ProjectSelector.deleteProject':
        await testProjectDeletion(step);
        break;
      case 'Navigation.scenes':
      case 'Navigation.generation':
      case 'Navigation.debug':
        await testNavigation(step);
        break;
      case 'ProjectForm.nameInput':
      case 'ProjectForm.submit':
        await testFormInteraction(step);
        break;
      case 'ErrorBoundary.testError':
        await testErrorTrigger(step);
        break;
      case 'ErrorBoundary.retry':
        await testErrorRecovery(step);
        break;
      default:
        console.log(`âš ï¸ æœªå®ç°æµ‹è¯•æ­¥éª¤: ${step.action}`);
    }
  };

  const testProjectCreation = async (step: TestStep) => {
    try {
      // æ¨¡æ‹Ÿé¡¹ç›®åç§°è¾“å…¥
      const projectName = `æµ‹è¯•é¡¹ç›®-${Date.now()}`;

      // ä½¿ç”¨é¡¹ç›®storeåˆ›å»ºé¡¹ç›®
      await createProject(projectName);

      // éªŒè¯é¡¹ç›®æ˜¯å¦åˆ›å»ºæˆåŠŸ
      const projects = useProjectStore.getState().projects;
      const createdProject = projects.find(p => p.name === projectName);

      if (createdProject) {
        console.log(`âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸ: ${projectName}`);
      } else {
        throw new Error('é¡¹ç›®åˆ›å»ºå¤±è´¥');
      }
    } catch (error) {
      throw new Error(`é¡¹ç›®åˆ›å»ºæµ‹è¯•å¤±è´¥: ${error.message}`);
    }
  };

  const testProjectSwitching = async (step: TestStep) => {
    try {
      if (projects.length < 2) {
        console.log(`âš ï¸ éœ€è¦è‡³å°‘2ä¸ªé¡¹ç›®æ‰èƒ½æµ‹è¯•åˆ‡æ¢`);
        return;
      }

      const nonCurrentProjects = projects.filter(p => p.id !== currentProject?.id);
      if (nonCurrentProjects.length > 0) {
        const targetProject = nonCurrentProjects[0];
        await useProjectStore.getState().setCurrentProject(targetProject.id);

        console.log(`âœ… é¡¹ç›®åˆ‡æ¢æˆåŠŸ: ${targetProject.name}`);
      }
    } catch (error) {
      throw new Error(`é¡¹ç›®åˆ‡æ¢æµ‹è¯•å¤±è´¥: ${error.message}`);
    }
  };

  const testProjectDeletion = async (step: TestStep) => {
    try {
      if (projects.length <= 1) {
        console.log(`âš ï¸ ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªé¡¹ç›®`);
        return;
      }

      const nonCurrentProjects = projects.filter(p => p.id !== currentProject?.id);
      if (nonCurrentProjects.length > 0) {
        const targetProject = nonCurrentProjects[0];
        await deleteProject(targetProject.id);

        console.log(`âœ… é¡¹ç›®åˆ é™¤æˆåŠŸ: ${targetProject.name}`);
      }
    } catch (error) {
      throw new Error(`é¡¹ç›®åˆ é™¤æµ‹è¯•å¤±è´¥: ${error.message}`);
    }
  };

  const testNavigation = async (step: TestStep) => {
    try {
      const targetPath = step.action.includes('åœºæ™¯') ? '/scenes' :
                      step.action.includes('ç”Ÿæˆ') ? '/video-generation' :
                      step.action.includes('è°ƒè¯•') ? '/debug' : '/';

      // æ¨¡æ‹Ÿå¯¼èˆª
      router.push(targetPath);

      // ç­‰å¾…è·¯ç”±å®Œæˆ
      await sleep(500);

      console.log(`âœ… å¯¼èˆªæˆåŠŸ: ${targetPath}`);
    } catch (error) {
      throw new Error(`å¯¼èˆªæµ‹è¯•å¤±è´¥: ${error.message}`);
    }
  };

  const testFormInteraction = async (step: TestStep) => {
    try {
      if (step.action.includes('ç©ºè¡¨å•')) {
        console.log(`ğŸ“ æ¨¡æ‹Ÿç©ºè¡¨å•æäº¤`);
        // æ¨¡æ‹Ÿè¡¨å•éªŒè¯é”™è¯¯
      } else {
        console.log(`ğŸ“ æ¨¡æ‹Ÿè¡¨å•å¡«å†™: ${step.action}`);
        // æ¨¡æ‹Ÿè¡¨å•å¡«å†™
      }
    } catch (error) {
      throw new Error(`è¡¨å•äº¤äº’æµ‹è¯•å¤±è´¥: ${error.message}`);
    }
  };

  const testErrorTrigger = async (step: TestStep) => {
    try {
      // è§¦å‘æµ‹è¯•é”™è¯¯
      errorMonitor.logError({
        type: 'javascript',
        message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯',
        source: 'UserInteractionTester.testErrorTrigger',
        context: { testStep: step }
      });

      console.log(`ğŸ› æµ‹è¯•é”™è¯¯è§¦å‘æˆåŠŸ`);
    } catch (error) {
      throw new Error(`é”™è¯¯è§¦å‘æµ‹è¯•å¤±è´¥: ${error.message}`);
    }
  };

  const testErrorRecovery = async (step: TestStep) => {
    try {
      console.log(`ğŸ”„ æ‰§è¡Œé”™è¯¯æ¢å¤æ“ä½œ`);
      // æ¨¡æ‹Ÿæ¢å¤æ“ä½œ
      await sleep(1000);

      console.log(`âœ… é”™è¯¯æ¢å¤æˆåŠŸ`);
    } catch (error) {
      throw new Error(`é”™è¯¯æ¢å¤æµ‹è¯•å¤±è´¥: ${error.message}`);
    }
  };

  const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

  const runAllTests = async () => {
    setIsTestRunning(true);
    setTestResults([]);
    setUserActions([]);

    // æŒ‰ä¼˜å…ˆçº§æ’åºæµ‹è¯•åœºæ™¯
    const sortedScenarios = [...testScenarios].sort((a, b) => {
      const priorityOrder = { high: 0, medium: 1, low: 2 };
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    });

    for (const scenario of sortedScenarios) {
      await executeTest(scenario);

      // æµ‹è¯•é—´éš”
      if (autoMode) {
        await sleep(2000 * getTimeoutDelay());
      } else {
        await sleep(1000);
      }
    }

    setIsTestRunning(false);
  };

  const runSingleTest = async (scenarioId: string) => {
    const scenario = testScenarios.find(s => s.id === scenarioId);
    if (scenario) {
      await executeTest(scenario);
    }
  };

  const clearResults = () => {
    setTestResults([]);
    setUserActions([]);
    setTestHistory([]);
    errorMonitor.clearErrors();
  };

  const getTestStatistics = () => {
    const total = testResults.length;
    const passed = testResults.filter(r => r.status === 'passed').length;
    const failed = testResults.filter(r => r.status === 'failed').length;
    const averageDuration = total > 0
      ? testResults.reduce((sum, r) => sum + (r.duration || 0), 0) / total
      : 0;

    return { total, passed, failed, averageDuration };
  };

  const getPriorityColor = (priority: string) => {
    const colors = {
      high: 'text-red-600 bg-red-100',
      medium: 'text-yellow-600 bg-yellow-100',
      low: 'text-green-600 bg-green-100'
    };
    return colors[priority as keyof typeof colors] || colors.low;
  };

  const getStatusColor = (status: string) => {
    const colors = {
      pending: 'text-gray-600 bg-gray-100',
      running: 'text-blue-600 bg-blue-100',
      passed: 'text-green-600 bg-green-100',
      failed: 'text-red-600 bg-red-100',
      error: 'text-red-800 bg-red-200'
    };
    return colors[status as keyof typeof colors] || colors.pending;
  };

  const formatDuration = (ms: number) => {
    return (ms / 1000).toFixed(2) + 's';
  };

  const toggleScenarioExpanded = (scenarioId: string) => {
    setExpandedScenarios(prev => {
      const newSet = new Set(prev);
      if (newSet.has(scenarioId)) {
        newSet.delete(scenarioId);
      } else {
        newSet.add(scenarioId);
      }
      return newSet;
    });
  };

  return (
    <div className="max-w-7xl mx-auto p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center space-x-3">
          <MouseClick className="w-8 h-8 text-blue-600" />
          <div>
            <h1 className="text-2xl font-bold text-gray-900">ç”¨æˆ·äº¤äº’æµç¨‹æµ‹è¯•</h1>
            <p className="text-gray-600">è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒéªŒè¯ç”¨æˆ·äº¤äº’æµç¨‹</p>
          </div>
        </div>

        <div className="flex items-center space-x-3">
          <button
            onClick={() => setAutoMode(!autoMode)}
            className={`px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors ${
              autoMode
                ? 'bg-green-600 text-white hover:bg-green-700'
                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            }`}
            disabled={isTestRunning}
          >
            {autoMode ? 'è‡ªåŠ¨æ¨¡å¼' : 'æ‰‹åŠ¨æ¨¡å¼'}
          </button>

          <select
            value={testSpeed}
            onChange={(e) => setTestSpeed(e.target.value as any)}
            className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
            disabled={isTestRunning}
          >
            <option value="slow">æ…¢é€Ÿ</option>
            <option value="normal">æ­£å¸¸</option>
            <option value="fast">å¿«é€Ÿ</option>
          </select>

          <button
            onClick={runAllTests}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg flex items-center space-x-2 hover:bg-blue-700 transition-colors"
            disabled={isTestRunning}
          >
            {isTestRunning ? (
              <>
                <Pause className="w-4 h-4" />
                <span>è¿è¡Œä¸­...</span>
              </>
            ) : (
              <>
                <Play className="w-4 h-4" />
                <span>è¿è¡Œæ‰€æœ‰æµ‹è¯•</span>
              </>
            )}
          </button>

          <button
            onClick={clearResults}
            className="px-4 py-2 bg-gray-600 text-white rounded-lg flex items-center space-x-2 hover:bg-gray-700 transition-colors"
            disabled={isTestRunning}
          >
            <RotateCw className="w-4 h-4" />
            <span>æ¸…é™¤ç»“æœ</span>
          </button>
        </div>
      </div>

      {/* ç»Ÿè®¡ä¿¡æ¯ */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white rounded-lg shadow p-4 border border-gray-200">
          <div className="flex items-center justify-between">
            <span className="text-sm text-gray-600">æ€»æµ‹è¯•æ•°</span>
            <span className="text-2xl font-bold text-gray-900">{getTestStatistics().total}</span>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow p-4 border border-gray-200">
          <div className="flex items-center justify-between">
            <span className="text-sm text-gray-600">é€šè¿‡</span>
            <span className="text-2xl font-bold text-green-600">{getTestStatistics().passed}</span>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow p-4 border border-gray-200">
          <div className="flex items-center justify-between">
            <span className="text-sm text-gray-600">å¤±è´¥</span>
            <span className="text-2xl font-bold text-red-600">{getTestStatistics().failed}</span>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow p-4 border border-gray-200">
          <div className="flex items-center justify-between">
            <span className="text-sm text-gray-600">å¹³å‡è€—æ—¶</span>
            <span className="text-2xl font-bold text-blue-600">
              {formatDuration(getTestStatistics().averageDuration)}
            </span>
          </div>
        </div>
      </div>

      {/* æµ‹è¯•åœºæ™¯åˆ—è¡¨ */}
      <div className="space-y-4">
        <h2 className="text-xl font-semibold text-gray-900">æµ‹è¯•åœºæ™¯</h2>

        {testScenarios.map(scenario => (
          <div
            key={scenario.id}
            className="bg-white rounded-lg shadow border border-gray-200 overflow-hidden"
          >
            <div
              className="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50"
              onClick={() => toggleScenarioExpanded(scenario.id)}
            >
              <div className="flex-1 min-w-0">
                <div className="flex items-center space-x-3">
                  <span className={`px-2 py-1 rounded text-xs font-medium ${getPriorityColor(scenario.priority)}`}>
                    {scenario.priority === 'high' ? 'é«˜' : scenario.priority === 'medium' ? 'ä¸­' : 'ä½'}
                  </span>
                  <h3 className="font-medium text-gray-900">{scenario.name}</h3>
                  <span className="text-sm text-gray-600">{scenario.category}</span>
                </div>
                <p className="text-sm text-gray-500 mt-1">{scenario.description}</p>
              </div>

              <div className="flex items-center space-x-2">
                {currentTest === scenario.id && (
                  <div className="flex items-center space-x-1">
                    <div className="w-2 h-2 bg-blue-600 rounded-full animate-pulse" />
                    <span className="text-blue-600 text-sm">è¿è¡Œä¸­</span>
                  </div>
                )}

                {testResults.find(r => r.testId === scenario.id) && (
                  <span className={`px-2 py-1 rounded text-xs font-medium ${getStatusColor(testResults.find(r => r.testId === scenario.id)?.status)}`}>
                    {testResults.find(r => r.testId === scenario.id)?.status === 'passed' && 'âœ“'}
                    {testResults.find(r => r.testId === scenario.id)?.status === 'failed' && 'âœ—'}
                    {testResults.find(r => r.testId === scenario.id)?.status === 'error' && 'âš ï¸'}
                  </span>
                )}

                <button
                  onClick={() => runSingleTest(scenario.id)}
                  className="px-3 py-1 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors"
                  disabled={isTestRunning}
                >
                  è¿è¡Œ
                </button>
              </div>
            </div>

            {expandedScenarios.has(scenario.id) && (
              <div className="border-t border-gray-200 p-4 bg-gray-50">
                <h4 className="font-medium text-gray-900 mb-3">æµ‹è¯•æ­¥éª¤</h4>
                <div className="space-y-2">
                  {scenario.steps.map((step, index) => {
                  const stepResult = testResults
                    .find(r => r.testId === scenario.id)
                    ?.details?.steps[index];

                  return (
                    <div
                      key={step.id}
                      className="flex items-start space-x-3 p-2 rounded hover:bg-white"
                    >
                      <div className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs font-medium text-gray-600">
                        {index + 1}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="text-sm font-medium text-gray-900">{step.name}</div>
                        <div className="text-xs text-gray-600 mt-1">{step.action}</div>

                        {stepResult && (
                          <div className="flex items-center space-x-2 mt-1">
                            <span className={`px-1 py-0.5 rounded text-xs ${
                              stepResult.status === 'completed'
                                ? 'bg-green-100 text-green-700'
                                : stepResult.status === 'failed'
                                ? 'bg-red-100 text-red-700'
                                : 'bg-gray-100 text-gray-700'
                            }`}>
                              {stepResult.status === 'completed' && 'âœ…'}
                              {stepResult.status === 'failed' && 'âŒ'}
                              {stepResult.status === 'pending' && 'â³'}
                            </span>
                            {stepResult.duration && (
                              <span className="text-xs text-gray-500">
                                ({formatDuration(stepResult.duration)})
                              </span>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        ))}
      </div>

      {/* å®æ—¶ç”¨æˆ·æ“ä½œ */}
      <div className="bg-white rounded-lg shadow p-6 border border-gray-200">
        <h2 className="text-xl font-semibold text-gray-900 mb-4">å®æ—¶ç”¨æˆ·æ“ä½œ</h2>
        <div className="max-h-64 overflow-y-auto">
          {userActions.length === 0 ? (
            <div className="text-center text-gray-500 py-8">
              <MouseClick className="w-12 h-12 mx-auto mb-3 text-gray-300" />
              <p>æš‚æ— ç”¨æˆ·æ“ä½œè®°å½•</p>
            </div>
          ) : (
            <div className="space-y-2">
              {userActions.map((action, index) => (
                <div
                  key={action.id}
                  className={`flex items-center justify-between p-2 rounded-lg ${
                    action.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'
                  }`}
                >
                  <div className="flex items-center space-x-3">
                    <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium ${
                      action.success ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
                    }`}>
                      {action.success ? 'âœ“' : 'âœ—'}
                    </span>
                    <div>
                      <div className="text-sm font-medium text-gray-900">
                        {action.action}
                      </div>
                      <div className="text-xs text-gray-600">
                        {action.target} â€¢ {action.timestamp.toLocaleTimeString()}
                      </div>
                    </div>
                    <div className="text-xs text-gray-500">
                      {action.responseTime && `(${formatDuration(action.responseTime)})}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* å†å²è®°å½• */}
      {testHistory.length > 0 && (
        <div className="bg-white rounded-lg shadow p-6 border border-gray-200">
          <h2 className="text-2xl font-semibold text-gray-900 mb-4">æµ‹è¯•å†å²è®°å½•</h2>
          <div className="max-h-64 overflow-y-auto">
            <div className="space-y-2">
              {testHistory.map((test, index) => (
                <div
                  key={`${test.testId}-${index}`}
                  className={`flex items-center justify-between p-3 rounded-lg border ${
                    test.status === 'passed'
                      ? 'border-green-200 bg-green-50'
                      : test.status === 'failed'
                      ? 'border-red-200 bg-red-50'
                      : 'border-gray-200 bg-gray-50'
                  }`}
                >
                  <div className="flex items-center space-x-3">
                    <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium ${
                      test.status === 'passed'
                        ? 'bg-green-600 text-white'
                        : test.status === 'failed'
                        ? 'bg-red-600 text-white'
                        : 'bg-gray-600 text-white'
                    }`}>
                      {test.status === 'passed' && 'âœ“'}
                      {test.status === 'failed' && 'âœ—'}
                      {test.status === 'error' && 'âš ï¸'}
                      {test.status === 'running' && 'â³'}
                    </span>
                    <div>
                      <div className="text-sm font-medium text-gray-900">
                        {test.testName}
                      </div>
                      <div className="text-xs text-gray-600">
                        {test.test.startTime?.toLocaleTimeString()} - {test.endTime?.toLocaleTimeString()}
                      </div>
                      {test.duration && (
                        <div className="text-xs text-gray-500">
                          è€—æ—¶: {formatDuration(test.duration)}
                        </div>
                      )}
                      {test.error && (
                        <div className="text-xs text-red-600 mt-1 truncate max-w-xs">
                          {test.error}
                        </div>
                      )}
                    </div>
                    <div className="text-xs text-gray-500">
                      {test.details?.completedSteps}/{test.details?.totalSteps} æ­¥éª¤
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};